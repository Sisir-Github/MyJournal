@page "/calendar"
@using JournalApp.Services
@using JournalApp.Models
@inject JournalService JournalService
@inject NavigationManager Navigation

<PageTitle>Calendar - Journal App</PageTitle>

<div class="cal-wrap">

    <!-- Top Bar -->
    <div class="cal-topbar">
        <div class="cal-brand">
            <div class="cal-logo">J</div>
            <div>
                <div class="cal-title">Journal Calendar</div>
                <div class="cal-sub">Select a day to view, edit, or create an entry</div>
            </div>
        </div>

        <div class="cal-actions">
            <button class="cal-btn ghost" @onclick="GoToday">Today</button>

            <div class="cal-month">
                <button class="cal-btn ghost" @onclick="PreviousMonth" title="Previous month">‚Äπ</button>
                <div class="cal-month-text">@currentDate.ToString("MMMM yyyy")</div>
                <button class="cal-btn ghost" @onclick="NextMonth" title="Next month">‚Ä∫</button>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="cal-main">
        <!-- Left: Calendar -->
        <section class="cal-card">
            <div class="cal-weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>

            <div class="cal-grid">
                @foreach (var day in calendarDays)
                {
                    var hasEntry = entriesByDate.ContainsKey(day.Date);
                    var isOtherMonth = day.Month != currentDate.Month;
                    var isToday = day.Date == DateTime.Now.Date;
                    var isSelected = selectedDate.HasValue && day.Date == selectedDate.Value.Date;

                    string moodCategory = "";
                    string moodEmoji = "";

                    if (hasEntry)
                    {
                        var entry = entriesByDate[day.Date];
                        moodCategory = entry.PrimaryMoodCategory.ToString();
                        moodEmoji = GetMoodEmoji(moodCategory);
                    }

                    <button type="button"
                            class="@($"cal-cell {(isOtherMonth ? "other" : "")} {(isToday ? "today" : "")} {(isSelected ? "selected" : "")} {(hasEntry ? "has" : "")}")"
                            @onclick="() => SelectDate(day)">
                        <div class="cal-cell-top">
                            <div class="cal-daynum">@day.Day</div>

                            @if (hasEntry)
                            {
                                <div class="@($"cal-dot {GetMoodIndicatorClass(moodCategory)}")" title="@moodCategory">
                                    <span class="cal-emoji">@moodEmoji</span>
                                </div>
                            }
                        </div>

                        @if (hasEntry)
                        {
                            var entry = entriesByDate[day.Date];
                            <div class="cal-mini-title">@entry.Title</div>
                        }
                        else
                        {
                            <div class="cal-mini-title empty">‚Äî</div>
                        }
                    </button>
                }
            </div>

            <div class="cal-legend">
                <div class="cal-legend-item"><span class="cal-legend-dot positive"></span> Positive</div>
                <div class="cal-legend-item"><span class="cal-legend-dot neutral"></span> Neutral</div>
                <div class="cal-legend-item"><span class="cal-legend-dot negative"></span> Negative</div>
                <div class="cal-legend-item"><span class="cal-legend-dot today"></span> Today</div>
                <div class="cal-legend-item"><span class="cal-legend-dot selected"></span> Selected</div>
            </div>
        </section>

        <!-- Right: Details -->
        <aside class="cal-side">
            @if (selectedDate == null)
            {
                <div class="cal-card cal-empty">
                    <div class="cal-empty-emoji">üóìÔ∏è</div>
                    <div class="cal-empty-title">No date selected</div>
                    <div class="cal-empty-sub">Pick any day from the calendar.</div>
                </div>
            }
            else
            {
                <div class="cal-card cal-datecard">
                    <div class="cal-date-left">
                        <div class="cal-date-big">@selectedDate.Value.ToString("dd")</div>
                        <div class="cal-date-small">@selectedDate.Value.ToString("MMM")</div>
                    </div>
                    <div class="cal-date-right">
                        <div class="cal-date-week">@selectedDate.Value.ToString("dddd")</div>
                        <div class="cal-date-full">@selectedDate.Value.ToString("MMMM dd, yyyy")</div>
                    </div>
                </div>

                @if (selectedEntry == null)
                {
                    <div class="cal-card">
                        <div class="cal-panel-title">No entry for this date</div>
                        <div class="cal-panel-sub">Create one and start tracking your mood & thoughts.</div>

                        <button class="cal-btn primary wide" @onclick="() => CreateEntryForDate(selectedDate.Value)">
                            ‚úçÔ∏è Create Entry
                        </button>
                    </div>
                }
                else
                {
                    <div class="cal-card">
                        <div class="cal-entry-head">
                            <div>
                                <div class="cal-panel-title">@selectedEntry.Title</div>
                                <div class="cal-panel-sub">Tap edit to update this entry.</div>
                            </div>
                            <button class="cal-btn primary" @onclick="() => EditEntry(selectedEntry.Id)">‚úèÔ∏è Edit</button>
                        </div>

                        <div class="cal-badges">
                            <span class="@($"cal-badge {GetMoodIndicatorClass(selectedEntry.PrimaryMoodCategory.ToString())}")">
                                @GetMoodEmoji(selectedEntry.PrimaryMoodCategory.ToString()) @selectedEntry.PrimaryMood
                            </span>

                            @if (!string.IsNullOrEmpty(selectedEntry.SecondaryMood1))
                            {
                                <span class="cal-badge soft">@selectedEntry.SecondaryMood1</span>
                            }
                            @if (!string.IsNullOrEmpty(selectedEntry.SecondaryMood2))
                            {
                                <span class="cal-badge soft">@selectedEntry.SecondaryMood2</span>
                            }
                        </div>

                        <div class="cal-preview">
                            @selectedEntry.Content
                        </div>

                        @if (!string.IsNullOrEmpty(selectedEntry.Tags))
                        {
                            <div class="cal-tags">
                                @foreach (var tag in selectedEntry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="cal-tag">@tag.Trim()</span>
                                }
                            </div>
                        }

                        <div class="cal-meta">
                            <div>üìù @selectedEntry.WordCount words</div>
                            <div>üïí Updated: @selectedEntry.UpdatedAt.ToString("g")</div>
                        </div>
                    </div>
                }
            }
        </aside>
    </div>

    <!-- Single-file styles -->
    <style>
        .cal-wrap{
            padding:16px;
            max-width:1200px;
            margin:0 auto;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        .cal-topbar{
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            flex-wrap:wrap;
            margin-bottom:14px;
        }

        .cal-brand{display:flex;align-items:center;gap:10px;}
        .cal-logo{
            width:38px;height:38px;border-radius:12px;
            display:flex;align-items:center;justify-content:center;
            background:var(--button-bg);color:var(--button-text);font-weight:900;
            box-shadow:var(--panel-shadow);
        }
        .cal-title{font-size:20px;font-weight:900;letter-spacing:-0.4px;margin:0;}
        .cal-sub{opacity:0.70;font-size:13px;margin-top:2px;}

        .cal-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .cal-month{
            display:flex;align-items:center;gap:6px;
            padding:6px 8px;border-radius:999px;
            border:1px solid var(--panel-border);
            background:var(--panel-bg);
        }
        .cal-month-text{font-weight:900;min-width:150px;text-align:center;}

        .cal-btn{
            height:36px;
            padding:0 12px;
            border-radius:10px;
            border:1px solid var(--panel-border);
            background:var(--chip-bg);
            font-weight:900;
            cursor:pointer;
            color:var(--text-color);
        }
        .cal-btn.ghost{background:transparent;}
        .cal-btn.primary{
            background:var(--button-bg);color:var(--button-text);border-color:var(--button-bg);
        }
        .cal-btn.wide{width:100%;margin-top:12px;}

        .cal-main{
            display:grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap:12px;
            align-items:start;
        }

        .cal-card{
            border-radius:18px;
            border:1px solid var(--panel-border);
            background:var(--panel-bg);
            box-shadow:var(--panel-shadow);
            padding:14px;
        }

        .cal-weekdays{
            display:grid;
            grid-template-columns:repeat(7,minmax(0,1fr));
            gap:8px;
            margin-bottom:10px;
        }
        .cal-weekdays > div{
            text-align:center;
            font-size:12px;
            font-weight:900;
            opacity:0.70;
            padding:6px 0;
        }

        .cal-grid{
            display:grid;
            grid-template-columns:repeat(7,minmax(0,1fr));
            gap:10px;
        }

        .cal-cell{
            border-radius:16px;
            border:1px solid var(--panel-border);
            background:var(--panel-bg);
            padding:10px;
            min-height:86px;
            text-align:left;
            cursor:pointer;
            box-shadow:var(--panel-shadow);
            transition: transform 0.08s ease, box-shadow 0.08s ease;
        }
        .cal-cell:hover{
            transform: translateY(-1px);
            box-shadow:0 12px 28px rgba(0,0,0,0.08);
        }
        .cal-cell.other{
            background:var(--soft-bg);
            opacity:0.75;
        }
        .cal-cell.today{
            border:2px solid var(--text-muted);
        }
        .cal-cell.selected{
            background:var(--hover-bg);
            border:2px solid var(--text-color);
        }
        .cal-cell.has{
            border-color: var(--soft-border);
        }

        .cal-cell-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;}
        .cal-daynum{font-weight:900;font-size:14px;}

        .cal-dot{
            width:30px;height:30px;border-radius:999px;
            display:flex;align-items:center;justify-content:center;
            border:1px solid var(--soft-border);
            background:var(--chip-bg);
        }
        .cal-dot.positive{background:rgba(34,197,94,0.18);border-color:rgba(34,197,94,0.35);}
        .cal-dot.neutral{background:rgba(59,130,246,0.16);border-color:rgba(59,130,246,0.32);}
        .cal-dot.negative{background:rgba(239,68,68,0.16);border-color:rgba(239,68,68,0.32);}
        .cal-emoji{font-size:15px;line-height:1;}

        .cal-mini-title{
            margin-top:10px;
            font-size:11px;
            opacity:0.78;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }
        .cal-mini-title.empty{opacity:0.35;}

        .cal-legend{
            margin-top:14px;
            padding-top:12px;
            border-top:1px solid var(--border-color);
            display:flex;
            flex-wrap:wrap;
            gap:10px;
        }
        .cal-legend-item{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:800;opacity:0.8;}
        .cal-legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;background:var(--soft-border);}
        .cal-legend-dot.positive{background:rgba(34,197,94,0.85);}
        .cal-legend-dot.neutral{background:rgba(59,130,246,0.85);}
        .cal-legend-dot.negative{background:rgba(239,68,68,0.85);}
        .cal-legend-dot.today{background:var(--text-color);}
        .cal-legend-dot.selected{background:var(--text-muted);}

        .cal-side{display:flex;flex-direction:column;gap:12px;}

        .cal-empty{text-align:center;padding:22px 14px;}
        .cal-empty-emoji{font-size:44px;}
        .cal-empty-title{font-size:18px;font-weight:900;margin-top:10px;}
        .cal-empty-sub{opacity:0.7;margin-top:4px;font-size:13px;}

        .cal-datecard{
            display:flex;
            align-items:center;
            gap:12px;
            padding:14px;
        }
        .cal-date-left{
            width:70px;height:70px;border-radius:18px;
            background:var(--button-bg);color:var(--button-text);
            display:flex;flex-direction:column;align-items:center;justify-content:center;
        }
        .cal-date-big{font-size:26px;font-weight:900;line-height:1;}
        .cal-date-small{font-size:12px;opacity:0.85;font-weight:900;margin-top:2px;}
        .cal-date-week{font-weight:900;font-size:14px;}
        .cal-date-full{opacity:0.75;font-size:13px;margin-top:2px;}

        .cal-panel-title{font-size:16px;font-weight:900;}
        .cal-panel-sub{opacity:0.70;font-size:13px;margin-top:4px;}

        .cal-entry-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;}

        .cal-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
        .cal-badge{
            padding:8px 10px;border-radius:999px;
            font-size:13px;font-weight:900;
            border:1px solid var(--panel-border);
            background:var(--chip-bg);
        }
        .cal-badge.positive{background:rgba(34,197,94,0.18);border-color:rgba(34,197,94,0.32);}
        .cal-badge.neutral{background:rgba(59,130,246,0.16);border-color:rgba(59,130,246,0.30);}
        .cal-badge.negative{background:rgba(239,68,68,0.16);border-color:rgba(239,68,68,0.30);}
        .cal-badge.soft{background:var(--soft-bg);}

        .cal-preview{
            margin-top:12px;
            font-size:13px;
            opacity:0.88;
            line-height:1.45;
            max-height:160px;
            overflow:auto;
            white-space:pre-wrap;
            border-radius:14px;
            border:1px solid var(--soft-border);
            background:var(--soft-bg);
            padding:10px;
        }

        .cal-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
        .cal-tag{padding:7px 10px;border-radius:999px;background:var(--chip-bg);font-size:12px;font-weight:900;}

        .cal-meta{margin-top:12px;display:flex;flex-direction:column;gap:6px;font-size:12px;opacity:0.75;}
    </style>
</div>

@code {
    private DateTime currentDate = DateTime.Now;
    private DateTime? selectedDate;
    private List<DateTime> calendarDays = new();
    private Dictionary<DateTime, JournalEntry> entriesByDate = new();
    private JournalEntry? selectedEntry;

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendar();
    }

    private async Task LoadCalendar()
    {
        calendarDays.Clear();
        entriesByDate.Clear();

        // Get first day of month
        var firstDayOfMonth = new DateTime(currentDate.Year, currentDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Calculate start date (include previous month days to fill first week)
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);

        // Calculate end date (include next month days to fill last week)
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);

        // Generate calendar days
        for (var date = startDate; date <= endDate; date = date.AddDays(1))
        {
            calendarDays.Add(date);
        }

        // Load entries for the month
        var entries = await JournalService.FilterByDateRangeAsync(startDate, endDate);
        entriesByDate = entries.ToDictionary(e => e.EntryDate.Date);
    }

    private async Task PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
        selectedDate = null;
        selectedEntry = null;
        await LoadCalendar();
    }

    private async Task NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
        selectedDate = null;
        selectedEntry = null;
        await LoadCalendar();
    }

    private async Task SelectDate(DateTime date)
    {
        selectedDate = date;
        if (entriesByDate.ContainsKey(date.Date))
        {
            selectedEntry = entriesByDate[date.Date];
        }
        else
        {
            selectedEntry = null;
        }
        await Task.CompletedTask;
    }

    private async Task GoToday()
    {
        currentDate = DateTime.Now;
        selectedDate = DateTime.Now.Date;

        // If today has an entry, show it
        if (entriesByDate.ContainsKey(selectedDate.Value.Date))
            selectedEntry = entriesByDate[selectedDate.Value.Date];
        else
            selectedEntry = null;

        await LoadCalendar();
    }

    private string GetMoodIndicatorClass(string moodCategory)
    {
        return moodCategory.ToLower() switch
        {
            "positive" => "positive",
            "neutral" => "neutral",
            "negative" => "negative",
            _ => ""
        };
    }

    private string GetMoodEmoji(string moodCategory)
    {
        return moodCategory.ToLower() switch
        {
            "positive" => "üòä",
            "neutral" => "üòê",
            "negative" => "üòî",
            _ => "üòê"
        };
    }

    private void EditEntry(int entryId)
    {
        Navigation.NavigateTo($"/edit-entry/{entryId}");
    }

    private void CreateEntryForDate(DateTime date)
    {
        Navigation.NavigateTo($"/create-entry?date={date:yyyy-MM-dd}");
    }
}
